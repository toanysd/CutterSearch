/* ========================================================================

MOBILE PANEL CONTROLLER R6.9.8

========================================================================

Quáº£n lÃ½ show/hide chi tiáº¿t & action buttons trÃªn iPhone

OPTIMIZATIONS:
- Touch event optimization (passive listeners)
- Memory cleanup (remove listeners on destroy)
- Debounced transitions (reduce reflows)
- Hardware acceleration (transform instead of top/left)
- DOM caching (reduce queries)
- Event delegation
- Smooth scrolling with RAF

Created: 2025-11-07
Last Updated: 2025-11-14 (R6.9.8 - Performance Optimized)

======================================================================== */

class MobilePanelController {
  constructor() {
    // DOM Elements Cache
    this.resultsPanel = null;
    this.detailPanel = null;
    this.filterPanel = null;
    this.filterToggle = null;
    this.filterContent = null;
    
    // State
    this.isFilterPanelOpen = false;
    this.isMobile = window.innerWidth < 768;
    this.isInitialized = false;
    
    // Event handlers (for cleanup)
    this.boundHandlers = new Map();
    
    // Performance config
    this.config = {
      transitionDuration: 300,
      debounceDelay: 150,
      useRAF: true,
      enablePerfMonitor: false
    };
    
    // Initialize only on mobile
    if (!this.isMobile) {
      console.log('[MobileController] Desktop detected, skipping initialization');
      return;
    }

    this.init();
  }

  // ========================================
  // INITIALIZATION
  // ========================================

  init() {
    console.log('[MobileController] Initializing r6.9.8...');
    
    // Cache DOM elements
    this.cacheDOMElements();
    
    // Setup event listeners
    this.setupEventListeners();
    
    // Initial state
    this.hideDetailPanel();
    
    this.isInitialized = true;
    console.log('[MobileController] Initialized successfully');
  }

  cacheDOMElements() {
    this.resultsPanel = document.querySelector('.quick-results-panel');
    this.detailPanel = document.querySelector('.detail-panel');
    this.filterPanel = document.getElementById('mobile-filter-panel');
    this.filterToggle = document.getElementById('mobile-filter-toggle');
    this.filterContent = document.getElementById('mobile-filter-content');
    
    // Validate
    if (!this.resultsPanel) {
      console.warn('[MobileController] Results panel not found');
    }
    if (!this.detailPanel) {
      console.warn('[MobileController] Detail panel not found');
    }
  }

  // ========================================
  // EVENT LISTENERS (Optimized)
  // ========================================

  setupEventListeners() {
    // 1. Quick result card click (via event delegation)
    this.attachQuickResultListener();
    
    // 2. Filter toggle
    this.attachFilterToggleListener();
    
    // 3. Custom events
    this.attachCustomEventListeners();
    
    // 4. Window resize (debounced)
    this.attachResizeListener();
    
    // 5. Back button
    this.attachBackButtonListener();
  }

  /**
   * Event delegation cho quick result cards
   */
  attachQuickResultListener() {
    if (!this.resultsPanel) return;
    
    const handler = this.debounce((e) => {
      const card = e.target.closest('.quick-result-card');
      if (!card) return;
      
      this.onQuickResultClick(card);
    }, this.config.debounceDelay);
    
    this.resultsPanel.addEventListener('click', handler, { passive: true });
    this.boundHandlers.set('resultsPanel:click', { el: this.resultsPanel, type: 'click', handler });
  }

  /**
   * Filter toggle listener
   */
  attachFilterToggleListener() {
    if (!this.filterToggle) return;
    
    const handler = (e) => {
      e.preventDefault();
      this.toggleFilterPanel();
    };
    
    this.filterToggle.addEventListener('click', handler);
    this.boundHandlers.set('filterToggle:click', { el: this.filterToggle, type: 'click', handler });
  }

  /**
   * Custom event listeners
   */
  attachCustomEventListeners() {
    const events = [
      { name: 'quick:select', handler: (e) => this.onQuickSelect(e) },
      { name: 'detail:changed', handler: (e) => this.onDetailChanged(e) },
      { name: 'detail:cleared', handler: () => this.hideDetailPanel() }
    ];
    
    events.forEach(({ name, handler }) => {
      const boundHandler = handler.bind(this);
      document.addEventListener(name, boundHandler);
      this.boundHandlers.set(`document:${name}`, { el: document, type: name, handler: boundHandler });
    });
  }

  /**
   * Window resize listener (debounced)
   */
  attachResizeListener() {
    const handler = this.debounce(() => {
      this.isMobile = window.innerWidth < 768;
      
      if (!this.isMobile) {
        console.log('[MobileController] Switched to desktop, cleaning up');
        this.cleanup();
      }
    }, 300);
    
    window.addEventListener('resize', handler, { passive: true });
    this.boundHandlers.set('window:resize', { el: window, type: 'resize', handler });
  }

  /**
   * Back button listener
   */
  attachBackButtonListener() {
    const backBtn = document.querySelector('.mobile-back-btn');
    if (!backBtn) return;
    
    const handler = (e) => {
      e.preventDefault();
      this.hideDetailPanel();
    };
    
    backBtn.addEventListener('click', handler);
    this.boundHandlers.set('backBtn:click', { el: backBtn, type: 'click', handler });
  }

  // ========================================
  // EVENT HANDLERS
  // ========================================

  onQuickResultClick(card) {
    if (!card) return;
    
    const id = card.dataset.id;
    const type = card.dataset.type;
    
    if (!id || !type) {
      console.warn('[MobileController] Invalid card data:', { id, type });
      return;
    }
    
    console.log('[MobileController] Card clicked:', { id, type });
    
    // Show detail panel with animation
    this.showDetailPanel();
    
    // Highlight selected card
    this.highlightCard(card);
    
    // Dispatch event Ä‘á»ƒ load data
    document.dispatchEvent(new CustomEvent('quick:select', {
      detail: { id, type }
    }));
  }

  onQuickSelect(e) {
    const { id, type } = e.detail || {};
    if (!id || !type) return;
    
    console.log('[MobileController] Quick select:', { id, type });
    this.showDetailPanel();
  }

  onDetailChanged(e) {
    const { item } = e.detail || {};
    if (!item) return;
    
    console.log('[MobileController] Detail changed:', item.displayCode);
    // Detail panel should already be visible
  }

  // ========================================
  // PANEL SHOW/HIDE (Optimized with RAF)
  // ========================================

  /**
   * Show detail panel vá»›i smooth animation
   */
  showDetailPanel() {
    if (!this.detailPanel) return;
    
    const performShow = () => {
      // Hide results panel
      if (this.resultsPanel) {
        this.resultsPanel.style.display = 'none';
      }
      
      // Show detail panel
      this.detailPanel.style.display = 'block';
      
      // Hardware-accelerated animation
      this.detailPanel.style.transform = 'translateX(0)';
      this.detailPanel.style.opacity = '1';
      
      // Show action buttons
      this.showActionButtons();
      
      // Add "View full detail" link (náº¿u chÆ°a cÃ³)
      this.insertViewFullDetailLink();
    };
    
    if (this.config.useRAF) {
      requestAnimationFrame(performShow);
    } else {
      performShow();
    }
  }

  /**
   * Hide detail panel vá»›i smooth animation
   */
  hideDetailPanel() {
    if (!this.detailPanel) return;
    
    const performHide = () => {
      // Animate out
      this.detailPanel.style.transform = 'translateX(100%)';
      this.detailPanel.style.opacity = '0';
      
      // After animation, hide completely
      setTimeout(() => {
        this.detailPanel.style.display = 'none';
        
        // Show results panel
        if (this.resultsPanel) {
          this.resultsPanel.style.display = 'block';
        }
        
        // Hide action buttons
        this.hideActionButtons();
      }, this.config.transitionDuration);
    };
    
    if (this.config.useRAF) {
      requestAnimationFrame(performHide);
    } else {
      performHide();
    }
  }

  /**
   * Toggle filter panel
   */
  toggleFilterPanel() {
    if (!this.filterPanel || !this.filterContent) return;
    
    this.isFilterPanelOpen = !this.isFilterPanelOpen;
    
    const performToggle = () => {
      if (this.isFilterPanelOpen) {
        // Open
        this.filterPanel.classList.add('open');
        this.filterContent.style.maxHeight = `${this.filterContent.scrollHeight}px`;
        this.filterContent.style.opacity = '1';
        
        // Update toggle button
        if (this.filterToggle) {
          this.filterToggle.classList.add('active');
          this.filterToggle.textContent = 'ãƒ•ã‚£ãƒ«ã‚¿ã‚’é–‰ã˜ã‚‹ â–²';
        }
      } else {
        // Close
        this.filterPanel.classList.remove('open');
        this.filterContent.style.maxHeight = '0';
        this.filterContent.style.opacity = '0';
        
        // Update toggle button
        if (this.filterToggle) {
          this.filterToggle.classList.remove('active');
          this.filterToggle.textContent = 'ãƒ•ã‚£ãƒ«ã‚¿ã‚’é–‹ã â–¼';
        }
      }
    };
    
    if (this.config.useRAF) {
      requestAnimationFrame(performToggle);
    } else {
      performToggle();
    }
  }

  // ========================================
  // ACTION BUTTONS
  // ========================================

  showActionButtons() {
    const container = document.querySelector('.mobile-action-buttons-container');
    if (!container) return;
    
    const performShow = () => {
      container.style.display = 'flex';
      container.style.transform = 'translateY(0)';
      container.style.opacity = '1';
    };
    
    if (this.config.useRAF) {
      requestAnimationFrame(performShow);
    } else {
      performShow();
    }
  }

  hideActionButtons() {
    const container = document.querySelector('.mobile-action-buttons-container');
    if (!container) return;
    
    const performHide = () => {
      container.style.transform = 'translateY(20px)';
      container.style.opacity = '0';
      
      setTimeout(() => {
        container.style.display = 'none';
      }, this.config.transitionDuration);
    };
    
    if (this.config.useRAF) {
      requestAnimationFrame(performHide);
    } else {
      performHide();
    }
  }

  // ========================================
  // UTILITIES
  // ========================================

  /**
   * Highlight selected card
   */
  highlightCard(card) {
    if (!card || !this.resultsPanel) return;
    
    // Remove previous highlight
    this.resultsPanel.querySelectorAll('.qr-selected').forEach(c => {
      c.classList.remove('qr-selected');
    });
    
    // Add highlight
    card.classList.add('qr-selected');
    
    // Smooth scroll vÃ o view
    if (this.config.useRAF) {
      requestAnimationFrame(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    } else {
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  /**
   * Insert "View full detail" link
   */
  insertViewFullDetailLink() {
    if (!this.detailPanel) return;
    
    // Check if already exists
    const existingLink = this.detailPanel.querySelector('.view-full-detail-link');
    if (existingLink) return;
    
    // Get current item data
    const codeEl = this.detailPanel.querySelector('#detail-code-name');
    if (!codeEl) return;
    
    const codeText = codeEl.textContent || '';
    const code = codeText.split('-')[0]?.trim();
    if (!code) return;
    
    // Determine item type
    const isMold = code.startsWith('A') || code.startsWith('B');
    const detailPage = isMold ? 'detail-mold.html' : 'detail-cutter.html';
    
    // Create link
    const link = document.createElement('a');
    link.href = `${detailPage}?code=${encodeURIComponent(code)}`;
    link.className = 'view-full-detail-link';
    link.textContent = 'ðŸ“„ å…¨è©³ç´°ã‚’è¡¨ç¤º (Full Detail)';
    link.target = '_blank';
    
    // Insert at top of detail panel
    const firstSection = this.detailPanel.querySelector('.detail-section');
    if (firstSection) {
      firstSection.insertBefore(link, firstSection.firstChild);
    }
  }

  /**
   * Debounce function
   */
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ========================================
  // TOUCH GESTURES (Optimized for performance)
  // ========================================

  /**
   * Setup touch gestures (swipe to go back)
   */
  setupTouchGestures() {
    if (!this.detailPanel) return;
    
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      this.handleGesture(touchStartX, touchStartY, touchEndX, touchEndY);
    };
    
    // Passive listeners for better scroll performance
    this.detailPanel.addEventListener('touchstart', handleTouchStart, { passive: true });
    this.detailPanel.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // Store for cleanup
    this.boundHandlers.set('detailPanel:touchstart', {
      el: this.detailPanel,
      type: 'touchstart',
      handler: handleTouchStart
    });
    this.boundHandlers.set('detailPanel:touchend', {
      el: this.detailPanel,
      type: 'touchend',
      handler: handleTouchEnd
    });
  }

  /**
   * Handle swipe gesture
   */
  handleGesture(startX, startY, endX, endY) {
    const diffX = endX - startX;
    const diffY = endY - startY;
    
    // Minimum swipe distance: 100px
    const minSwipeDistance = 100;
    
    // Horizontal swipe detection
    if (Math.abs(diffX) > Math.abs(diffY)) {
      // Right swipe (go back)
      if (diffX > minSwipeDistance) {
        console.log('[MobileController] Right swipe detected, going back');
        this.hideDetailPanel();
      }
    }
  }

  // ========================================
  // MEMORY MANAGEMENT & CLEANUP
  // ========================================

  /**
   * Cleanup all event listeners (prevent memory leaks)
   */
  cleanup() {
    console.log('[MobileController] Cleaning up...');
    
    // Remove all bound event handlers
    this.boundHandlers.forEach(({ el, type, handler }) => {
      if (el && handler) {
        el.removeEventListener(type, handler);
      }
    });
    
    // Clear map
    this.boundHandlers.clear();
    
    // Clear DOM references
    this.resultsPanel = null;
    this.detailPanel = null;
    this.filterPanel = null;
    this.filterToggle = null;
    this.filterContent = null;
    
    this.isInitialized = false;
    console.log('[MobileController] Cleanup complete');
  }

  /**
   * Destroy and recreate (full reset)
   */
  reset() {
    this.cleanup();
    if (this.isMobile) {
      this.init();
    }
  }

  // ========================================
  // PERFORMANCE MONITORING
  // ========================================

  /**
   * Enable performance monitoring
   */
  enablePerfMonitor() {
    this.config.enablePerfMonitor = true;
    console.log('[MobileController] Performance monitoring enabled');
  }

  /**
   * Disable performance monitoring
   */
  disablePerfMonitor() {
    this.config.enablePerfMonitor = false;
    console.log('[MobileController] Performance monitoring disabled');
  }

  /**
   * Log performance metric
   */
  logPerf(label, duration) {
    if (this.config.enablePerfMonitor) {
      console.log(`[MobileController:PERF] ${label}: ${duration.toFixed(2)}ms`);
    }
  }

  // ========================================
  // PUBLIC API
  // ========================================

  /**
   * Programmatically show detail panel
   */
  show() {
    this.showDetailPanel();
  }

  /**
   * Programmatically hide detail panel
   */
  hide() {
    this.hideDetailPanel();
  }

  /**
   * Check if detail panel is visible
   */
  isDetailVisible() {
    if (!this.detailPanel) return false;
    return this.detailPanel.style.display === 'block';
  }

  /**
   * Get current state
   */
  getState() {
    return {
      isMobile: this.isMobile,
      isInitialized: this.isInitialized,
      isDetailVisible: this.isDetailVisible(),
      isFilterPanelOpen: this.isFilterPanelOpen
    };
  }
}

// ========================================
// INITIALIZE ON MOBILE ONLY
// ========================================

(function() {
  'use strict';
  
  // Check if mobile
  const isMobile = window.innerWidth < 768;
  
  if (!isMobile) {
    console.log('[MobileController] Desktop detected, not initializing');
    return;
  }
  
  // Wait for DOM ready
  function init() {
    console.log('[MobileController] Initializing mobile panel controller...');
    
    try {
      // Create instance
      window.MobileController = new MobilePanelController();
      
      // Setup touch gestures
      if (window.MobileController && window.MobileController.isInitialized) {
        window.MobileController.setupTouchGestures();
      }
      
      console.log('[MobileController] r6.9.8 loaded successfully');
    } catch (error) {
      console.error('[MobileController] Initialization error:', error);
    }
  }
  
  // Auto-init when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (window.MobileController && window.MobileController.cleanup) {
      window.MobileController.cleanup();
    }
  });
  
  // Handle orientation change
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      const newIsMobile = window.innerWidth < 768;
      if (window.MobileController) {
        window.MobileController.isMobile = newIsMobile;
        
        if (!newIsMobile) {
          window.MobileController.cleanup();
        } else if (!window.MobileController.isInitialized) {
          window.MobileController.init();
        }
      }
    }, 300); // Wait for orientation change to complete
  });
  
})();

// ========================================
// MOBILE DETAIL MODAL INTEGRATION
// ========================================

/**
 * Full-screen detail modal cho iPhone
 * TÃ­ch há»£p vá»›i MobilePanelController
 */
class MobileDetailModal {
  constructor() {
    this.modal = null;
    this.currentItem = null;
    this.currentItemType = null;
    this.isMobile = window.innerWidth < 768;
    
    if (!this.isMobile) return;
    
    this.init();
  }
  
  init() {
    console.log('[MobileDetailModal] Initializing...');
    
    // Listen for detail open requests
    document.addEventListener('detail:open', (e) => {
      const { id, type } = e.detail || {};
      if (!id || !type) return;
      
      this.openModal(id, type);
    });
    
    console.log('[MobileDetailModal] Initialized');
  }
  
  /**
   * Open full-screen modal
   */
  openModal(id, type) {
    console.log('[MobileDetailModal] Opening modal:', { id, type });
    
    // Determine page
    const isMold = type === 'mold' || id.startsWith('A') || id.startsWith('B');
    const page = isMold ? 'detail-mold.html' : 'detail-cutter.html';
    
    // Open in new window/tab
    const url = `${page}?code=${encodeURIComponent(id)}`;
    
    // On mobile, open in same tab for better UX
    if (this.isMobile) {
      window.location.href = url;
    } else {
      window.open(url, '_blank');
    }
  }
  
  /**
   * Close modal
   */
  closeModal() {
    // On mobile, use browser back button
    if (this.isMobile) {
      window.history.back();
    }
  }
}

// Initialize modal handler
if (window.innerWidth < 768) {
  window.MobileDetailModalHandler = new MobileDetailModal();
}

// ========================================
// UTILITY FUNCTIONS
// ========================================

/**
 * Detect if running on mobile device
 */
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

/**
 * Detect if running on iOS
 */
function isIOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

/**
 * Get safe area insets (for iPhone X+)
 */
function getSafeAreaInsets() {
  const safeAreaInsetTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sat') || '0');
  const safeAreaInsetBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sab') || '0');
  
  return {
    top: safeAreaInsetTop,
    bottom: safeAreaInsetBottom
  };
}

/**
 * Apply safe area padding to element
 */
function applySafeAreaPadding(element) {
  if (!element || !isIOS()) return;
  
  const insets = getSafeAreaInsets();
  element.style.paddingTop = `${insets.top}px`;
  element.style.paddingBottom = `${insets.bottom}px`;
}

// ========================================
// EXPORT UTILITIES
// ========================================

window.MobileUtils = {
  isMobileDevice,
  isIOS,
  getSafeAreaInsets,
  applySafeAreaPadding
};

console.log('[MobileController] r6.9.8 - Mobile utilities loaded');

// ========================================
// END OF mobile-controller-r6.9.8.js
// ========================================
