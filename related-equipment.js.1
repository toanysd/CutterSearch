/**
 * related-equipment.js - V7.7.7 FIXED
 * é€£æºè¨­å‚™ï¼ˆé–¢é€£ã™ã‚‹é‡‘å‹ãƒ»æŠœå‹ï¼‰/ Thiáº¿t bá»‹ liÃªn quan (KhuÃ´n/Dao cáº¯t)
 * 
 * LOGIC ÄÃšNG:
 * - Chá»n Mold â†’ Hiá»ƒn thá»‹ Cutter liÃªn quan: MoldID â†’ MoldDesignID â†’ CutterID (moldcutter.csv)
 * - Chá»n Cutter â†’ Hiá»ƒn thá»‹ Mold liÃªn quan: CutterID â†’ MoldDesignID â†’ MoldID (moldcutter.csv)
 * 
 * UX:
 * - Title Ä‘á»™ng: Chá»n Mold hiá»ƒn thá»‹ "é–¢é€£æŠœå‹/Dao cáº¯t", Chá»n Cutter hiá»ƒn thá»‹ "é–¢é€£é‡‘å‹/KhuÃ´n"
 * - Badge åˆ¥æŠœã mÃ u Ä‘á» ná»•i báº­t khi YES
 * - LuÃ´n xÃ³a tráº¯ng khi khÃ´ng cÃ³ dá»¯ liá»‡u, khÃ´ng hiá»ƒn thá»‹ record cÅ©
 * - Click item â†’ hiá»ƒn thá»‹ trong cá»™t 2, cá»™t 3, Ä‘Ã¡nh dáº¥u selected
 * - CSS tÃ¡ch riÃªng: related-equipment.css
 */
(function () {
  'use strict';

  const SELECTORS = {
    col4Area: '.actions-lower',
    relatedSection: '#related-equipment',
    resultsContainer: '#results-container',
    resultsTableRows: '.results-table tbody tr',
    resultCards: '.result-card'
  };

  const RelatedEquipment = {
    currentItem: null, // LÆ°u item hiá»‡n táº¡i Ä‘á»ƒ trÃ¡nh nháº§m láº«n
    currentSelectedId: null,

    init() {
      this.cache();
      this.ensureContainer();
      this.bindSelectionListeners();
      this.renderEmpty();
      console.log('[RelatedEquipment] é€£æºè¨­å‚™ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æº–å‚™å®Œäº† / Module thiáº¿t bá»‹ liÃªn quan Ä‘Ã£ sáºµn sÃ ng');
    },

    cache() {
      this.resultsRoot = document.querySelector(SELECTORS.resultsContainer) || document.body;
      this.col4Area = document.querySelector(SELECTORS.col4Area);
      this.wrap = document.querySelector(SELECTORS.relatedSection);
    },

    ensureContainer() {
      if (this.wrap && this.wrap.parentElement) return;
      if (!this.col4Area) {
        this.wrap = document.createElement('section');
        this.wrap.id = 'related-equipment';
        this.wrap.className = 'related-section';
        this.resultsRoot.insertAdjacentElement('afterend', this.wrap);
        return;
      }
      const sec = document.createElement('section');
      sec.id = 'related-equipment';
      sec.className = 'related-section';
      this.col4Area.prepend(sec);
      this.wrap = sec;
    },

    bindSelectionListeners() {
      // 1) Click trÃªn báº£ng káº¿t quáº£ (table rows)
      document.addEventListener('click', (e) => {
        const tr = e.target.closest(SELECTORS.resultsTableRows);
        if (!tr) return;
        const item = this.inferItemFromRow(tr);
        if (item) this.update(item);
      }, true);

      // 2) Click trÃªn tháº» káº¿t quáº£ (card view)
      document.addEventListener('click', (e) => {
        const card = e.target.closest(SELECTORS.resultCards);
        if (!card) return;
        const item = this.inferItemFromCard(card);
        if (item) this.update(item);
      }, true);

      // 3) API cÃ´ng khai
      window.showRelatedEquipment = (item) => this.update(item);
    },

    renderEmpty() {
      if (!this.wrap) this.ensureContainer();
      this.currentItem = null;
      this.currentSelectedId = null;
      this.wrap.classList.remove('is-mold', 'is-cutter');
      this.wrap.innerHTML = `
        <div class="related-header">
          <div class="related-title">
            <span class="main-text">é€£æºè¨­å‚™ / Thiáº¿t bá»‹ liÃªn quan</span>
          </div>
          <span class="dedicated-cutter-badge no">åˆ¥æŠœã: -</span>
        </div>
        <div class="related-empty">é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ / Vui lÃ²ng chá»n má»™t má»¥c</div>
      `;
    },

    update(item) {
      if (!item) {
        this.renderEmpty();
        return;
      }

      this.currentItem = item;
      const type = item.itemType || (item.MoldID ? 'mold' : 'cutter');
      this.wrap.classList.remove('is-mold', 'is-cutter');
      this.wrap.classList.add(type === 'mold' ? 'is-mold' : 'is-cutter');

      // SeparateCutter tá»« designInfo
      const sep = (item.designInfo?.SeparateCutter || '').toString().trim().toLowerCase();
      const isSeparate = sep === 'yes' || sep === '1' || sep === 'true' || sep === 'ã‚ã‚Š' || sep === 'æœ‰' || sep === 'åˆ¥æŠœã';
      const badgeClass = isSeparate ? 'yes' : 'no';
      const badgeText = `åˆ¥æŠœã: ${isSeparate ? 'YES' : 'NO'}`;

      // Láº¥y danh sÃ¡ch liÃªn quan ÄÃšNG LOGIC
      const related = type === 'mold'
        ? this.getRelatedCuttersForMold(item)
        : this.getRelatedMoldsForCutter(item);

      // Title Ä‘á»™ng
      const titleMain = type === 'mold' ? 'é–¢é€£æŠœå‹' : 'é–¢é€£é‡‘å‹';
      const titleSub = type === 'mold' ? 'Dao cáº¯t liÃªn quan' : 'KhuÃ´n liÃªn quan';

      // Render
      const listHtml = related.length === 0
        ? `<div class="related-empty">é–¢é€£ã™ã‚‹é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ / KhÃ´ng cÃ³ thiáº¿t bá»‹ liÃªn quan</div>`
        : `<div class="related-list">
            ${related.map(it => this.rowHtml(it, type)).join('')}
           </div>`;

      this.wrap.innerHTML = `
        <div class="related-header">
          <div class="related-title">
            <span class="main-text">${titleMain}</span>
            <span class="sub-text">${titleSub}</span>
          </div>
          <span class="dedicated-cutter-badge ${badgeClass}">${badgeText}</span>
        </div>
        ${listHtml}
      `;

      // Gáº¯n click cho tá»«ng dÃ²ng â†’ hiá»ƒn thá»‹ trong cá»™t 2, cá»™t 3, Ä‘Ã¡nh dáº¥u selected
      this.wrap.querySelectorAll('.related-item').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-id') || '';
          if (!id) return;
          this.selectItem(id, el);
        });
      });
    },

    selectItem(id, clickedEl) {
      // TÃ¬m item theo ID
      const item = DataManager.data.molds.find(m => m.MoldID === id)
                || DataManager.data.cutters.find(c => c.CutterID === id);
      if (!item) return;

      this.currentSelectedId = id;

      // ÄÃ¡nh dáº¥u selected trong danh sÃ¡ch
      this.wrap.querySelectorAll('.related-item').forEach(el => el.classList.remove('is-selected'));
      if (clickedEl) clickedEl.classList.add('is-selected');

      // Hiá»ƒn thá»‹ trong cá»™t 2 (gá»i UIRenderer hoáº·c module hiá»ƒn thá»‹ chi tiáº¿t)
      if (window.UIRenderer && window.UIRenderer.showDetail) {
        window.UIRenderer.showDetail(item);
      }

      // Cáº­p nháº­t cá»™t 3 náº¿u cÃ³ module detail panel
      if (window.DetailPanel && window.DetailPanel.show) {
        window.DetailPanel.show(item);
      }

      console.log(`[RelatedEquipment] Selected: ${item.MoldID || item.CutterID}`, item);
    },

    // ==================== LOGIC ÄÃšNG: Mold â†’ Cutter ====================
    getRelatedCuttersForMold(mold) {
      if (!mold || !mold.MoldID) return [];

      // B1: MoldID â†’ MoldDesignID
      const designId = mold.MoldDesignID || mold.designInfo?.MoldDesignID;
      if (!designId) {
        console.warn(`[RelatedEquipment] Mold ${mold.MoldID} khÃ´ng cÃ³ MoldDesignID`);
        return [];
      }

      // B2: MoldDesignID â†’ CutterID (qua moldcutter.csv)
      const mcLinks = DataManager.data.moldcutter.filter(mc => mc.MoldDesignID === designId);
      if (!mcLinks || mcLinks.length === 0) {
        console.log(`[RelatedEquipment] MoldDesignID ${designId} khÃ´ng cÃ³ Cutter liÃªn káº¿t`);
        return [];
      }

      // B3: Láº¥y Cutter chi tiáº¿t
      const cutterIds = mcLinks.map(mc => mc.CutterID).filter(Boolean);
      const cutters = cutterIds.map(id => DataManager.data.cutters.find(c => c.CutterID === id))
                               .filter(Boolean)
                               .map(c => ({ ...c, itemType: 'cutter' }));

      console.log(`[RelatedEquipment] Mold ${mold.MoldID} â†’ Design ${designId} â†’ ${cutters.length} Cutters`);
      return cutters;
    },

    // ==================== LOGIC ÄÃšNG: Cutter â†’ Mold ====================
    getRelatedMoldsForCutter(cutter) {
      if (!cutter || !cutter.CutterID) return [];

      // B1: CutterID â†’ MoldDesignID (qua moldcutter.csv)
      const mcLinks = DataManager.data.moldcutter.filter(mc => mc.CutterID === cutter.CutterID);
      if (!mcLinks || mcLinks.length === 0) {
        console.log(`[RelatedEquipment] Cutter ${cutter.CutterID} khÃ´ng cÃ³ MoldDesign liÃªn káº¿t`);
        return [];
      }

      const designIds = mcLinks.map(mc => mc.MoldDesignID).filter(Boolean);
      if (designIds.length === 0) {
        console.warn(`[RelatedEquipment] Cutter ${cutter.CutterID} cÃ³ liÃªn káº¿t nhÆ°ng thiáº¿u MoldDesignID`);
        return [];
      }

      // B2: MoldDesignID â†’ MoldID
      const molds = DataManager.data.molds.filter(m => designIds.includes(m.MoldDesignID))
                                          .map(m => ({ ...m, itemType: 'mold' }));

      console.log(`[RelatedEquipment] Cutter ${cutter.CutterID} â†’ ${designIds.length} Designs â†’ ${molds.length} Molds`);
      return molds;
    },

    // ==================== ROW HTML ====================
    rowHtml(it, parentType) {
      const type = it.itemType || (it.MoldID ? 'mold' : 'cutter');
      const id = type === 'cutter' ? it.CutterID : it.MoldID;

      // Ná»™i dung hiá»ƒn thá»‹ theo loáº¡i
      let codeLine, infoLine;
      if (type === 'cutter') {
        // Cutter: CutterNo, CutterName
        codeLine = it.CutterNo || it.CutterID || '-';
        infoLine = it.CutterName || '-';
      } else {
        // Mold: MoldCode, kÃ­ch thÆ°á»›c
        codeLine = it.MoldCode || it.MoldID || '-';
        const dims = this.formatDimensions(it);
        infoLine = dims || it.MoldName || '-';
      }

      const loc = this.formatLocation(it);
      const icon = type === 'cutter' ? 'ğŸ”ª' : 'ğŸ§©';

      const selected = this.currentSelectedId === id ? 'is-selected' : '';

      return `
        <div class="related-item ${selected}" data-id="${escapeHtml(id)}" data-type="${type}">
          <span class="icon" aria-hidden="true">${icon}</span>
          <div class="main">
            <span class="code-line">${escapeHtml(codeLine)}</span>
            <span class="info-line" title="${escapeHtml(infoLine)}">${escapeHtml(infoLine)}</span>
          </div>
          <div class="badges">
            ${loc.rack ? `<span class="badge rack">${escapeHtml(loc.rack)}</span>` : ''}
            ${loc.layer ? `<span class="badge layer">${escapeHtml(loc.layer)}</span>` : ''}
          </div>
        </div>
      `;
    },

    formatDimensions(item) {
      const w = item.Width || item.width;
      const h = item.Height || item.height;
      const d = item.Depth || item.depth;
      const parts = [w, h, d].filter(x => x && !isNaN(x));
      return parts.length > 0 ? parts.join(' Ã— ') : '';
    },

    formatLocation(item) {
      const rackName = item.rackInfo?.RackName || item.rackId || item.rackInfo?.RackID || '';
      const layerName = item.rackLayerInfo?.Layer || item.rackLayerInfo?.RackLayerName || item.RackLayerID || '';
      const rack = rackName ? `GiÃ¡: ${rackName}` : '';
      const layer = layerName ? `Táº§ng: ${layerName}` : '';
      return { rack, layer };
    },

    // ==================== INFER ITEM ====================
    inferItemFromRow(tr) {
      try {
        const tds = Array.from(tr.querySelectorAll('td'));
        if (tds.length < 2) return null;
        const code = (tds[1].textContent || '').trim();
        if (!code) return null;

        let item = DataManager.data.molds.find(m => (m.MoldCode || '').trim() === code)
                || DataManager.data.cutters.find(c => (c.CutterNo || '').trim() === code);

        if (!item) {
          item = DataManager.data.molds.find(m => m.MoldID === code)
              || DataManager.data.cutters.find(c => c.CutterID === code);
        }

        if (item && !item.itemType) {
          item.itemType = item.MoldID ? 'mold' : 'cutter';
        }
        return item || null;
      } catch {
        return null;
      }
    },

    inferItemFromCard(card) {
      const code = card.getAttribute('data-code') || card.querySelector('[data-code]')?.getAttribute('data-code');
      if (code) {
        let item = DataManager.data.molds.find(m => (m.MoldCode || '').trim() === code)
                || DataManager.data.cutters.find(c => (c.CutterNo || '').trim() === code);
        if (item && !item.itemType) item.itemType = item.MoldID ? 'mold' : 'cutter';
        if (item) return item;
      }
      const text = (card.textContent || '').trim();
      if (!text) return null;
      let item = DataManager.data.molds.find(m => text.includes(m.MoldCode || '') || text.includes(m.MoldName || ''))
             || DataManager.data.cutters.find(c => text.includes(c.CutterNo || '') || text.includes(c.CutterName || ''));
      if (item && !item.itemType) item.itemType = item.MoldID ? 'mold' : 'cutter';
      return item || null;
    }
  };

  function escapeHtml(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  window.RelatedEquipment = RelatedEquipment;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => RelatedEquipment.init());
  } else {
    RelatedEquipment.init();
  }
})();
